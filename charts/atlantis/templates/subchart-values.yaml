{{/*
Dynamic Subchart Value Override
This template applies the value transformation to ensure the subchart
receives properly filtered and compatible values from atlantisConfig.
*/}}

{{/* CRITICAL: Apply validation first before transformation */}}
{{- include "atlantis.validateAll" . }}

{{/*
CORE TRANSFORMATION: Apply the official chart values transformation
and override the static atlantis: section with filtered, compatible values.
This is the key mechanism that makes the value pass-through work correctly.
*/}}
{{- $transformedValues := include "atlantis.officialChartValues" . | fromYaml }}
{{- $_ := set .Values "atlantis" $transformedValues }}

{{/*
VALIDATION: Ensure the transformation was applied correctly
and the resulting values are compatible with the official chart.
*/}}
{{- include "atlantis.validateTransformation" . }}

{{- if eq .Values.deployment.type "deployment" }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "atlantis.fullname" . }}-transformation-debug
  labels:
    {{- include "atlantis.labels" . | nindent 4 }}
  annotations:
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-weight: "-5"
data:
  deployment-mode: "deployment"
  transformation-applied: "true"
  transformed-values.yaml: |
    # Values passed to official Atlantis subchart
    {{- toYaml .Values.atlantis | nindent 4 }}
  note: |
    Transformation successfully applied. The atlantis: section now contains
    filtered values compatible with the official Atlantis chart schema.

{{- else }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "atlantis.fullname" . }}-transformation-debug
  labels:
    {{- include "atlantis.labels" . | nindent 4 }}
  annotations:
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-weight: "-5"
data:
  deployment-mode: "rollout"
  transformation-applied: "skipped"
  note: |
    Using Argo Rollouts mode. Official chart deployment disabled.
    No value transformation needed for subchart.
{{- end }}
