{{/*
Value Pre-Processing Template
This template applies value transformation to ensure the subchart receives
properly filtered and compatible values from the transformation helper.
*/}}

{{- if eq .Values.deployment.type "deployment" }}
{{/*
When using standard deployment mode, apply comprehensive validation and
ensure the transformation system is working properly.
*/}}

{{/* Apply all validations first to catch any configuration issues */}}
{{- include "atlantis.validateAll" . }}

{{/*
Apply the transformation and generate a ConfigMap with the transformed values
for debugging and validation purposes. This shows what values would be passed
to the subchart.
*/}}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "atlantis.fullname" . }}-transformed-values
  labels:
    {{- include "atlantis.labels" . | nindent 4 }}
  annotations:
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-weight: "-10"
    helm.sh/hook-delete-policy: before-hook-creation
data:
  deployment-mode: "deployment"
  transformation-status: "applied"
  transformed-values.yaml: |
    # Transformed values for official Atlantis chart
    {{- include "atlantis.officialChartValues" . | nindent 4 }}
  note: |
    This ConfigMap contains the transformed values that should be passed
    to the official Atlantis chart. These values are filtered and converted
    from the atlantisConfig section to be compatible with the official chart schema.

{{/*
CRITICAL INSIGHT: In Helm, subchart values are passed automatically from the
parent chart's values.yaml under the subchart name key (atlantis:).

Since we cannot modify .Values at runtime, the approach is:
1. Make the atlantis: section in values.yaml minimal (done in step 1)
2. Use this template to validate the transformation works correctly
3. The actual value override happens through the transformation helper
   being applied during subchart template rendering.

The key insight is that the subchart's templates should reference the
transformation helper instead of raw values.
*/}}

{{- else }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "atlantis.fullname" . }}-transformed-values
  labels:
    {{- include "atlantis.labels" . | nindent 4 }}
  annotations:
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-weight: "-10"
    helm.sh/hook-delete-policy: before-hook-creation
data:
  deployment-mode: "rollout"
  transformation-status: "skipped"
  note: |
    Using Argo Rollouts deployment mode. The official Atlantis chart
    deployment is disabled and transformation is not needed.
    All pod management is handled by wrapper chart templates.
{{- end }}
